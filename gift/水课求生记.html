<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¸“æ³¨æ—¶é’Ÿ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&display=swap');

        :root {
            --primary: #4F46E5;
            --secondary: #818CF8;
            --cta: #F97316;
            --bg: #EEF2FF;
            --text: #1E1B4B;
            --danger: #EF4444;
            --trap: #4B5563;
            --neon-glow: 0 0 10px rgba(79, 70, 229, 0.6), 0 0 20px rgba(79, 70, 229, 0.4);
            --crt-line: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg);
            overflow: hidden;
            font-family: 'Baloo 2', cursive, sans-serif;
            color: var(--text);
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* CRT Scanline Overlay */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%, 
                rgba(0, 0, 0, 0.1) 50%
            ), linear-gradient(
                90deg, 
                rgba(255, 0, 0, 0.03), 
                rgba(0, 255, 0, 0.01), 
                rgba(0, 0, 255, 0.03)
            );
            background-size: 100% 4px, 6px 100%;
            z-index: 999;
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }

        /* Start Screen - Retro Arcade Style */
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            background: radial-gradient(circle at center, #fff 0%, #e0e7ff 100%);
            transition: all 0.5s ease-out;
            padding: 20px;
            overflow-y: auto; /* Allow scrolling on small screens */
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 0 4px var(--text), 10px 10px 0 var(--secondary);
            text-align: center;
            max-width: 100%;
            width: 420px;
            transform: translateY(0);
            border: 4px solid var(--text);
            position: relative;
            margin: auto; /* Center vertically in flex container with scroll */
        }

        .emoji-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            display: inline-block;
            filter: drop-shadow(4px 4px 0 var(--secondary));
            animation: bounce 2s infinite;
            color: var(--primary);
        }

        h1 {
            font-size: 32px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 4px;
            text-transform: uppercase;
            text-shadow: 3px 3px 0 var(--secondary);
            letter-spacing: 1px;
        }

        .subtitle {
            color: var(--primary);
            font-size: 14px;
            margin-bottom: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Control Panel */
        .control-panel {
            background: #F3F4F6;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 3px solid var(--text);
            box-shadow: inset 4px 4px 0 rgba(0,0,0,0.05);
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 800;
            color: var(--text);
            font-size: 18px;
        }

        .multiplier-tag {
            background: var(--cta);
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 800;
            border: 2px solid var(--text);
            box-shadow: 2px 2px 0 var(--text);
        }

        /* Retro Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 12px;
            cursor: pointer;
            background: var(--text);
            border-radius: 6px;
            border: 2px solid var(--text);
        }

        input[type=range]::-webkit-slider-thumb {
            height: 24px;
            width: 24px;
            background: var(--primary);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -8px;
            border: 3px solid var(--text);
            border-radius: 4px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--secondary);
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--primary);
            margin-top: 12px;
            font-weight: 600;
        }

        /* Retro Start Button */
        .start-btn {
            width: 100%;
            padding: 16px;
            font-size: 24px;
            font-weight: 800;
            background: var(--primary);
            color: white;
            border: 4px solid var(--text);
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 6px 6px 0 var(--text);
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
            font-family: 'Baloo 2', cursive;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 8px 8px 0 var(--text);
            background: var(--secondary);
        }

        .start-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 0 0 0 var(--text);
        }

        .hint-text {
            margin-top: 24px;
            color: #6B7280;
            font-size: 15px;
            line-height: 1.5;
            font-weight: 500;
        }

        .hint-highlight {
            color: var(--cta);
            font-weight: 800;
            font-size: 18px;
            text-shadow: 1px 1px 0 var(--text);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Game Over Screen */
        #gameOverScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            color: white;
            text-align: center;
        }

        .game-over-title {
            font-size: 60px;
            color: var(--danger);
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        .game-over-reason {
            font-size: 24px;
            color: #fff;
            margin-bottom: 40px;
            max-width: 80%;
        }

        .retry-btn {
            padding: 15px 50px;
            font-size: 24px;
            background: var(--cta);
            color: white;
            border: 4px solid #fff;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Baloo 2', cursive;
            font-weight: 800;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
            transition: transform 0.2s;
        }

        .retry-btn:hover {
            transform: scale(1.1);
        }

        /* Level Up Toast */
        #levelUpToast {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(79, 70, 229, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 16px;
            border: 4px solid #fff;
            font-size: 32px;
            font-weight: 800;
            z-index: 150;
            pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
/* ç¡®ä¿ endGameButtons å®¹å™¨æ ·å¼å­˜åœ¨ */
        #endGameButtons {
            position: fixed;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            display: none; /* åˆå§‹éšè— */
            flex-direction: column;
            gap: 15px;
            z-index: 200;
        }

        /* Mobile Optimization: Fit to screen without scrolling */
        @media (max-height: 800px) {
            .card {
                padding: 15px 20px !important;
                width: 95% !important;
                max-width: 380px !important;
            }
            .emoji-icon {
                width: 40px !important;
                height: 40px !important;
                margin-bottom: 5px !important;
            }
            h1 {
                font-size: 24px !important;
                margin-bottom: 2px !important;
            }
            .subtitle {
                font-size: 12px !important;
                margin-bottom: 10px !important;
            }
            .control-panel {
                padding: 10px !important;
                margin-bottom: 15px !important;
            }
            .control-label {
                font-size: 14px !important;
                margin-bottom: 5px !important;
            }
            input[type=range] {
                height: 8px !important;
            }
            input[type=range]::-webkit-slider-thumb {
                height: 18px !important;
                width: 18px !important;
                margin-top: -6px !important;
            }
            .range-labels {
                margin-top: 5px !important;
                font-size: 10px !important;
            }
            .start-btn {
                padding: 10px !important;
                font-size: 20px !important;
            }
            .hint-text {
                margin-top: 10px !important;
                font-size: 12px !important;
                line-height: 1.3 !important;
            }
            /* Adjust spacing for difficulty section */
            #difficultyPanel input {
                padding: 2px !important;
                font-size: 12px !important;
            }
        }
        /* Screen Shake Animation */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake-effect {
            animation: shake 0.5s;
            animation-iteration-count: 1;
        }

        /* Stage Banner */
        #stageBanner {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 100%;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 30px 0;
            z-index: 180;
            pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px);
        }

        #stageBanner h2 {
            font-size: 48px;
            color: var(--secondary);
            margin-bottom: 10px;
            text-shadow: 4px 4px 0 var(--text);
            font-family: 'Baloo 2', cursive;
        }

        #stageBanner p {
            font-size: 24px;
            color: #fff;
            font-weight: 600;
        }
    </style>
</head>
<body id="gameBody">

    <canvas id="gameCanvas"></canvas>

    <div class="crt-overlay"></div>
    <div id="startScreen">
        <div class="card">
            <svg class="emoji-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <h1>æ°´è¯¾æ±‚ç”Ÿè®°</h1>
            <p class="subtitle">å‘¨æ–‡æ²›å®šåˆ¶ç‰ˆ Â· 45åˆ†é’ŸæŒ‘æˆ˜</p>
            
            <div style="margin-bottom: 20px; font-weight: 800; color: var(--cta);">
                ğŸ‘‘ å†å²æœ€é«˜åˆ†: <span id="highScoreDisplay">0</span>
            </div>

            <div class="control-panel">
                <div class="control-label">
                    <span>æ—¶é—´æµé€å€ç‡</span>
                    <span class="multiplier-tag"><span id="timeScaleDisplay">1</span>x</span>
                </div>
                <input type="range" id="timeScaleInput" min="1" max="100" value="1" step="1">
                <div class="range-labels">
                    <span>çœŸå®æ—¶é—´ (1x)</span>
                    <span>å…‰é€Ÿé€ƒé€¸ (100x)</span>
                </div>
                
                <p style="font-size: 12px; color: #6B7280; margin-top: 8px; text-align: left; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 5px;">
                    â„¹ï¸ <strong>å€ç‡è¯´æ˜</strong>ï¼š<br>
                    â€¢ <strong>1x</strong>: ä½“éªŒçœŸå®çš„45åˆ†é’Ÿç…ç†¬è¯¾ç¨‹ã€‚<br>
                    â€¢ <strong>60x</strong>: 1ç§’é’Ÿ=æ¸¸æˆå†…1åˆ†é’Ÿï¼Œ45ç§’å³å¯é€šå…³ã€‚<br>
                    â€¢ è°ƒå¾—è¶Šå¿«ï¼Œæ¸¸æˆèŠ‚å¥è¶Šå¿«ï¼Œè€ƒéªŒæ‰‹é€Ÿï¼
                </p>

                <!-- éš¾åº¦è®¾ç½®æŠ˜å åŒºåŸŸ -->
                <div style="margin-top: 20px; border-top: 2px dashed var(--text); padding-top: 15px;">
                    <div class="control-label" style="font-size: 16px; cursor: pointer;" onclick="toggleDifficultyPanel()">
                        <span>âš™ï¸ å…³å¡ç›®æ ‡åˆ†æ•°è®¾ç½® (ç‚¹å‡»å±•å¼€)</span>
                        <span>â–¼</span>
                    </div>
                    <div id="difficultyPanel" style="display: none; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <!-- JSå°†ä¼šå¡«å……è¿™é‡Œ -->
                    </div>
                </div>
            </div>

            <button class="start-btn" id="startBtn">å¼€å§‹ä¸Šè¯¾</button>
            
            <p class="hint-text">
                ç©æ³•æç¤ºï¼šå¯»æ‰¾å¹¸è¿æ•°å­— <span class="hint-highlight">6</span> å’Œ <span class="hint-highlight">5</span><br>
                æ¯å…³éœ€è¾¾åˆ°ç›®æ ‡åˆ†æ•°ï¼Œå¦åˆ™å°†è¢«æ·˜æ±°ï¼
            </p>
        </div>
    </div>

    <div id="gameOverScreen">
        <h1 class="game-over-title">GAME OVER</h1>
        <p class="game-over-reason" id="gameOverReason">ä½ ç¡ç€äº†...</p>
        <button class="retry-btn" onclick="returnToMenu()">è¿”å›ä¸»èœå•</button>
    </div>
    
    <div id="endGameButtons">
        <button class="retry-btn" onclick="returnToMenu()">è¿”å›ä¸»èœå•</button>
    </div>

    <div id="levelUpToast">LEVEL UP!</div>
    
    <div id="stageBanner">
        <h2 id="stageBannerTitle">LEVEL 1</h2>
        <p id="stageBannerDesc">æ½œä¼æœŸ</p>
    </div>

<script>
/**
 * ==========================================
 * é…ç½®åŒºåŸŸ (Configuration)
 * ==========================================
 */
// æ—¶é—´æµé€å€ç‡ (ç”±ç”¨æˆ·è®¾ç½®)
let TIME_SCALE = 1; 

const TOTAL_MINUTES = 45;

const COLORS = {
    bg: '#f0f9ff',
    bgPink: '#fff0f5', // ç¥æ¸¸é˜¶æ®µèƒŒæ™¯
    bgDark: '#e6f7ff',
    primary: '#333333',
    lucky: '#FFB6C1', // ç”Ÿæ—¥ç²‰ (LightPink)
    luckyBorder: '#FFD700', // é‡‘è‰²
    bubbleDefault: '#e1f5fe',
    text: '#2c3e50',
    danger: '#ff4d4f'
};

// æ¸¸æˆé˜¶æ®µå®šä¹‰ (æ·»åŠ ç›®æ ‡åˆ†æ•° minScore)
const STAGES = {
    0: { name: 'IDLE', start: 0, end: 8, title: 'Level 1: æ½œä¼æœŸ', desc: 'å‡è£…å¬è¯¾ (ç›®æ ‡: 100åˆ†)', minScore: 100 },
    1: { name: 'BLUR', start: 8, end: 16, title: 'Level 2: å›°å€¦æœŸ', desc: 'åˆ«ç¡ç€ï¼(ç›®æ ‡: 300åˆ†)', minScore: 300 },
    2: { name: 'DREAM', start: 16, end: 24, title: 'Level 3: ç¥æ¸¸æœŸ', desc: 'ç¦åˆ©æ—¶é—´ (ç›®æ ‡: 600åˆ†)', minScore: 600 },
    3: { name: 'PANIC', start: 24, end: 33, title: 'Level 4: æé—®æœŸ', desc: 'çº¢ç¯åœï¼(ç›®æ ‡: 1000åˆ†)', minScore: 1000 },
    4: { name: 'MATH', start: 33, end: 44, title: 'Level 5: ç…ç†¬æœŸ', desc: 'å‡‘11ç‚¹ (ç›®æ ‡: 1500åˆ†)', minScore: 1500 },
    5: { name: 'FREEDOM', start: 44, end: 100, title: 'Level 6: ä¸‹è¯¾ï¼', desc: 'è‡ªç”±å•¦ï¼ï¼ï¼', minScore: 0 }
};

// å¼¹å¹•æ–‡æ¡ˆ
const BARRAGE_TEXTS = [
    "è€å¸ˆè¿™PPTå¥½åƒæœ‰50é¡µ...", 
    "ç©ºè°ƒæ˜¯ä¸æ˜¯æœ‰ç‚¹å†·...", 
    "ä¸­åˆåƒéº»è¾£çƒ«è¿˜æ˜¯ç›–é¥­...", 
    "è¿™çŸ¥è¯†å®ƒä¸è¿›è„‘å­å•Š...",
    "æ–‡æ²›ï¼ŒåšæŒä½...",
    "å†æ’‘ä¸€ä¸‹...",
    "æˆ‘æ˜¯è°ï¼Ÿæˆ‘åœ¨å“ªï¼Ÿ",
    "æƒ³å–å¥¶èŒ¶..."
];

/**
 * ==========================================
 * æ¸¸æˆæ ¸å¿ƒé€»è¾‘ (Game Logic)
 * ==========================================
 */
let canvas, ctx;
let width, height;
let gameStartTime;
let lastFrameTime;
let currentStageIndex = 0;
let lastStageIndex = 0; // è®°å½•ä¸Šä¸€å¸§çš„é˜¶æ®µï¼Œç”¨äºæ£€æµ‹åˆ‡æ¢
let bubbles = [];
let particles = [];
let floatingTexts = [];
let score = 0;
let combo = 0; // å½“å‰è¿å‡»æ•°
let maxCombo = 0; // æœ€å¤§è¿å‡»è®°å½•
let highScore = parseInt(localStorage.getItem('sk_highScore') || 0); // è¯»å–æœ€é«˜åˆ†
let luckyClickCount = 0; // è®°å½•ç‚¹äº†å¤šå°‘æ¬¡6å’Œ5

// éŸ³æ•ˆä¸Šä¸‹æ–‡
let audioCtx;

// çŠ¶æ€å˜é‡
let blurLevel = 0;
let panicEyeState = 'CLOSED'; // OPEN or CLOSED
let panicTimer = 0;
let panicStrikeCount = 0; // è®°å½•è¢«å‘ç°æ¬¡æ•°
let mathTarget = 11;
let mathCurrent = 0;
let currentBarrage = null;
let isGameOver = false;
let animationId = null; // åŠ¨ç”»å¸§ID

window.onload = () => {
    canvas = document.getElementById('gameCanvas');
    ctx = canvas.getContext('2d');
    resize();
    window.addEventListener('resize', resize);
    
    // ç»‘å®šäº¤äº’äº‹ä»¶ (åªç»‘å®šä¸€æ¬¡)
    canvas.addEventListener('mousedown', handleInput);
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
        handleInput(e.touches[0]);
    }, {passive: false});

    // é…ç½®æ»‘å—é€»è¾‘
    const scaleInput = document.getElementById('timeScaleInput');
    const scaleDisplay = document.getElementById('timeScaleDisplay');
    
    scaleInput.addEventListener('input', (e) => {
        TIME_SCALE = parseInt(e.target.value);
        scaleDisplay.textContent = TIME_SCALE;
    });
    
    // æ˜¾ç¤ºå†å²æœ€é«˜åˆ†
    document.getElementById('highScoreDisplay').textContent = highScore;
    
    // åˆå§‹åŒ–éš¾åº¦è®¾ç½®é¢æ¿
    const difficultyPanel = document.getElementById('difficultyPanel');
    for (let i = 0; i < 5; i++) {
        const stage = STAGES[i];
        const div = document.createElement('div');
        div.style.textAlign = 'left';
        div.innerHTML = `
            <label style="font-size: 12px; color: #666; display: block;">${stage.title.split(':')[0]}</label>
            <input type="number" id="scoreTarget${i}" value="${stage.minScore}" 
                style="width: 100%; padding: 5px; border: 2px solid var(--text); border-radius: 5px; font-family: 'Baloo 2';">
        `;
        difficultyPanel.appendChild(div);
    }

    document.getElementById('startBtn').addEventListener('click', () => {
        // åˆå§‹åŒ–éŸ³æ•ˆ
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // åº”ç”¨ç”¨æˆ·è®¾ç½®çš„ç›®æ ‡åˆ†æ•°
        for (let i = 0; i < 5; i++) {
            const input = document.getElementById(`scoreTarget${i}`);
            const val = parseInt(input.value);
            if (!isNaN(val) && val >= 0) {
                STAGES[i].minScore = val;
                // æ›´æ–°æè¿°æ–‡æ¡ˆ
                STAGES[i].desc = STAGES[i].desc.replace(/ç›®æ ‡: \d+åˆ†/, `ç›®æ ‡: ${val}åˆ†`);
            }
        }

        const screen = document.getElementById('startScreen');
        screen.style.opacity = 0;
        setTimeout(() => {
            screen.style.display = 'none';
            startGame();
        }, 500);
    });
};

function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
}

function startGame() {
    // é‡ç½®æ¸¸æˆçŠ¶æ€
    score = 0;
    combo = 0;
    maxCombo = 0;
    luckyClickCount = 0;
    blurLevel = 0;
    panicEyeState = 'CLOSED';
    panicTimer = 0;
    panicStrikeCount = 0;
    mathCurrent = 0;
    currentBarrage = null;
    isGameOver = false;
    currentStageIndex = 0;
    lastStageIndex = 0;
    
    // æ¸…ç©ºå®ä½“
    bubbles = [];
    particles = [];
    floatingTexts = [];

    gameStartTime = Date.now();
    lastFrameTime = Date.now();
    
    if (animationId) cancelAnimationFrame(animationId);
    loop();
}

function returnToMenu() {
    // éšè—æ¸¸æˆç»“æŸç•Œé¢
    document.getElementById('gameOverScreen').style.display = 'none';
    document.getElementById('endGameButtons').style.display = 'none';
    
    // æ˜¾ç¤ºå¼€å§‹ç•Œé¢
    const screen = document.getElementById('startScreen');
    screen.style.display = 'flex';
    // å¼ºåˆ¶é‡ç»˜ä»¥è§¦å‘è¿‡æ¸¡
    void screen.offsetWidth; 
    screen.style.opacity = 1;
    
    // åœæ­¢æ¸¸æˆå¾ªç¯
    isGameOver = true;
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
    
    // æ¸…é™¤ç”»å¸ƒ
    ctx.clearRect(0, 0, width, height);
}

function toggleDifficultyPanel() {
    const panel = document.getElementById('difficultyPanel');
    const isHidden = panel.style.display === 'none';
    
    // Toggle display
    panel.style.display = isHidden ? 'grid' : 'none';
    
    // Force repaint to fix mobile rendering glitches
    if (isHidden) {
        // Trigger reflow
        void panel.offsetWidth;
        
        // Ensure inputs are visible and interactive
        const inputs = panel.querySelectorAll('input');
        inputs.forEach(input => {
            input.style.transform = 'translateZ(0)'; // Hardware acceleration hint
        });
        
        // Scroll to make sure it's visible if off-screen
        setTimeout(() => {
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    }
}

function loop() {
    const now = Date.now();
    const deltaTime = (now - lastFrameTime) / 1000;
    lastFrameTime = now;

    // è®¡ç®—æ¸¸æˆå†…æ—¶é—´
    const realElapsedSec = (now - gameStartTime) / 1000;
    const gameMinutes = (realElapsedSec * TIME_SCALE) / 60;

    // æ›´æ–°é˜¶æ®µ
    if (!isGameOver) {
        lastStageIndex = currentStageIndex;
        updateStage(gameMinutes);
        
        // æ£€æµ‹é˜¶æ®µåˆ‡æ¢ (Level Progression Check)
        if (currentStageIndex > lastStageIndex) {
            checkLevelPass(lastStageIndex);
            // Show Stage Banner for new stage
            if (!isGameOver) {
                showStageBanner(currentStageIndex);
            }
        } else if (currentStageIndex === 0 && lastStageIndex === 0 && realElapsedSec < 1) {
             // æ¸¸æˆåˆšå¼€å§‹æ˜¾ç¤ºä¸€æ¬¡
             showStageBanner(0);
        }
    }

    // ç»˜åˆ¶èƒŒæ™¯
    drawBackground(gameMinutes);

    // é˜¶æ®µé€»è¾‘å¤„ç†
    if (!isGameOver) {
        handleStageLogic(gameMinutes, deltaTime);
    }

    // æ›´æ–°å®ä½“
    updateEntities(deltaTime);
    
    // ç»˜åˆ¶å®ä½“
    drawEntities();

    // ç»˜åˆ¶UI
    drawUI(gameMinutes);

    animationId = requestAnimationFrame(loop);
}

function updateStage(minutes) {
    for (let key in STAGES) {
        if (minutes >= STAGES[key].start && minutes < STAGES[key].end) {
            currentStageIndex = parseInt(key);
            break;
        }
    }
}

function drawBackground(gameMinutes) {
    // åŸºç¡€èƒŒæ™¯è‰²
    if (currentStageIndex === 2) {
        ctx.fillStyle = COLORS.bgPink; // ç¥æ¸¸æœŸç²‰è‰²
    } else if (currentStageIndex === 5) {
        ctx.fillStyle = '#fff'; // ä¸‹è¯¾åäº®ç™½
    } else {
        ctx.fillStyle = COLORS.bg;
    }
    ctx.fillRect(0, 0, width, height);

    // é˜¶æ®µ1ï¼šå›°å€¦æ¨¡ç³Šè’™å±‚
    if (currentStageIndex === 1 && blurLevel > 0) {
        ctx.fillStyle = `rgba(255, 255, 255, ${Math.min(blurLevel * 0.2, 0.95)})`;
        ctx.fillRect(0, 0, width, height);
        
        // å›°å€¦æç¤º
        if (blurLevel > 3.5) {
            ctx.font = "bold 30px 'Baloo 2'";
            ctx.fillStyle = COLORS.danger;
            ctx.textAlign = 'center';
            ctx.fillText("å¿«é†’é†’ï¼è¦ç¡ç€äº†ï¼", width/2, height/2);
        }
    }

    // ä¸­å¿ƒå¤§æ—¶é’Ÿ (é™¤äº†ç¥æ¸¸æœŸå’Œä¸‹è¯¾æœŸ)
    if (currentStageIndex !== 2 && currentStageIndex !== 5) {
        drawClock(gameMinutes);
    }
}

function drawClock(gameMinutes) {
    const cx = width / 2;
    const cy = height / 3;
    
    ctx.textAlign = 'center';
    
    // å€’è®¡æ—¶åˆ†é’Ÿæ•°
    let remainMin = Math.floor(TOTAL_MINUTES - gameMinutes);
    if (remainMin < 0) remainMin = 0;
    
    ctx.font = 'bold 80px -apple-system, BlinkMacSystemFont';
    ctx.fillStyle = 'rgba(0,0,0,0.05)';
    ctx.fillText(`${remainMin}'`, cx, cy);
    
    // é˜¶æ®µæç¤ºæ–‡å­—
    ctx.font = '16px sans-serif';
    ctx.fillStyle = '#999';
    ctx.fillText(STAGES[currentStageIndex].title, cx, cy + 50);
    ctx.font = '14px sans-serif';
    ctx.fillStyle = '#aaa';
    ctx.fillText(STAGES[currentStageIndex].desc, cx, cy + 75);
}

function handleStageLogic(minutes, dt) {
    const stage = currentStageIndex;

    // Stage 0: å¼¹å¹• + å°‘é‡æ³¡æ³¡
    if (stage === 0) {
        if (!currentBarrage && Math.random() < 0.01) {
            currentBarrage = {
                text: BARRAGE_TEXTS[Math.floor(Math.random() * BARRAGE_TEXTS.length)],
                x: width,
                y: height - 100 - Math.random() * 100
            };
        }
        if (currentBarrage) {
            ctx.font = "18px sans-serif";
            ctx.fillStyle = "rgba(0,0,0,0.4)";
            ctx.fillText(currentBarrage.text, currentBarrage.x, currentBarrage.y);
            currentBarrage.x -= 80 * dt;
            if (currentBarrage.x < -300) currentBarrage = null;
        }
        // æ–°å¢ï¼šæ½œä¼æœŸä¹Ÿè¦å¶å°”å‡ºæ³¡æ³¡ï¼Œå¦åˆ™æ— æ³•å¾—åˆ†
        if (Math.random() < 0.02) spawnBubble(false);
    }

    // Stage 1: å›°å€¦
    if (stage === 1) {
        // è§†é‡é€æ¸å˜ç³Š
        blurLevel = Math.min(blurLevel + dt * 0.3, 5.0);
        if (blurLevel >= 5.0) {
            gameOver("ä½ ç¡ç€äº†...è€å¸ˆå¾ˆç”Ÿæ°”");
            return;
        }
        // åŠ¨æ€éš¾åº¦ï¼šç”Ÿæˆç‡éšè¿å‡»æ•°ç•¥å¾®æå‡
        let spawnRate = 0.04 + (combo * 0.001);
        if (Math.random() < spawnRate) spawnBubble(false);
    } else {
        // ç¦»å¼€æ­¤é˜¶æ®µè¿…é€Ÿæ¢å¤
        if (blurLevel > 0) blurLevel -= dt * 2;
        if (blurLevel < 0) blurLevel = 0;
    }

    // Stage 2: ç¥æ¸¸ (ç¦åˆ©)
    if (stage === 2) {
        if (Math.random() < 0.15) spawnBubble(true);
    }

    // Stage 3: æé—® (çº¢ç»¿ç¯)
    if (stage === 3) {
        panicTimer += dt;
        let cycle = 5; // 5ç§’ä¸€ä¸ªå‘¨æœŸ
        let t = panicTimer % cycle;
        
        // æ˜¾ç¤ºå‰©ä½™æœºä¼š
        ctx.textAlign = 'left';
        ctx.font = "bold 20px 'Baloo 2'";
        ctx.fillStyle = COLORS.danger;
        ctx.fillText(`è­¦å‘Šæ¬¡æ•°: ${panicStrikeCount}/3`, 20, 80);

        // å‰3.5ç§’å®‰å…¨ï¼Œå1.5ç§’å±é™©
        if (t > 3.5) {
            panicEyeState = 'OPEN';
            // å±é™©çº¢å…‰èƒŒæ™¯
            ctx.fillStyle = `rgba(255, 0, 0, 0.15)`;
            ctx.fillRect(0, 0, width, height);
            
            drawEye(true);
        } else {
            panicEyeState = 'CLOSED';
            drawEye(false);
            if (Math.random() < 0.06) spawnBubble(false); // ç¨å¾®æé«˜ç”Ÿæˆç‡ï¼Œè¯±æƒ‘ç©å®¶
        }
    }

    // Stage 4: ç…ç†¬ (ç®—æœ¯)
    if (stage === 4) {
        ctx.textAlign = 'center';
        ctx.fillStyle = "#333";
        ctx.font = "bold 24px sans-serif";
        ctx.fillText(`å½“å‰ç‚¹æ•°: ${mathCurrent} / ${mathTarget}`, width/2, height/2 + 50);
        
        if (mathCurrent === mathTarget) {
            createFloatingText(width/2, height/2, "âœ¨ å®Œç¾ï¼ âœ¨", "#FFD700");
            mathCurrent = 0; // é‡ç½®
            score += 50;
        }
        
        if (Math.random() < 0.05) spawnBubble(false);
    }

    // Stage 5: ä¸‹è¯¾
    if (stage === 5) {
        if (Math.random() < 0.1) {
            createExplosion(
                Math.random() * width, 
                Math.random() * height * 0.6, 
                ['#FF5733', '#33FF57', '#3357FF', '#F333FF'][Math.floor(Math.random()*4)]
            );
        }
        drawEndScreen();
    }
}

function showStageBanner(index) {
    const banner = document.getElementById('stageBanner');
    const title = document.getElementById('stageBannerTitle');
    const desc = document.getElementById('stageBannerDesc');
    
    title.textContent = STAGES[index].title.split(':')[0]; // "Level X"
    desc.textContent = STAGES[index].desc;
    
    banner.style.transform = 'translate(-50%, -50%) scale(1)';
    setTimeout(() => {
        banner.style.transform = 'translate(-50%, -50%) scale(0)';
    }, 2500);
    
    // æ¸¸æˆå¼€å§‹æ—¶ä½¿ç”¨æŸ”å’Œçš„ start éŸ³æ•ˆï¼Œå…¶ä»–å…³å¡ä½¿ç”¨ lucky
    if (index === 0) {
        playSound('start');
    } else {
        playSound('lucky');
    }
}

function triggerShake() {
    const body = document.getElementById('gameBody');
    body.classList.remove('shake-effect');
    void body.offsetWidth; // trigger reflow
    body.classList.add('shake-effect');
}

// ç»˜åˆ¶â€œè€å¸ˆçš„çœ¼é•œâ€
function drawEye(isOpen) {
    const cx = width / 2;
    const cy = 100;
    
    ctx.lineWidth = 4;
    ctx.strokeStyle = '#333';
    
    // é•œæ¡†
    ctx.beginPath();
    ctx.arc(cx - 30, cy, 20, 0, Math.PI * 2);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(cx + 30, cy, 20, 0, Math.PI * 2);
    ctx.stroke();
    // é¼»æ¢
    ctx.beginPath();
    ctx.moveTo(cx - 10, cy);
    ctx.lineTo(cx + 10, cy);
    ctx.stroke();
    
    if (isOpen) {
        // ç³å­”
        ctx.fillStyle = '#FF0000';
        ctx.beginPath();
        ctx.arc(cx - 30, cy, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(cx + 30, cy, 8, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.font = "bold 20px sans-serif";
        ctx.fillStyle = "red";
        ctx.textAlign = "center";
        ctx.fillText("åˆ«åŠ¨ï¼", cx, cy + 50);
    } else {
        // é—­çœ¼çº¿
        ctx.beginPath();
        ctx.moveTo(cx - 40, cy);
        ctx.lineTo(cx - 20, cy);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(cx + 20, cy);
        ctx.lineTo(cx + 40, cy);
        ctx.stroke();
    }
}

function drawEndScreen() {
    // ä¿å­˜æœ€é«˜åˆ†
    if (score > highScore) {
        highScore = score;
        localStorage.setItem('sk_highScore', highScore);
    }

    ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
    ctx.fillRect(0, 0, width, height);
    
    ctx.textAlign = 'center';
    ctx.fillStyle = '#333';
    
    let y = height / 3;
    ctx.font = "bold 40px 'Baloo 2'";
    ctx.fillText("ğŸ‰ ç»ˆäºä¸‹è¯¾äº†ï¼ ğŸ‰", width/2, y);
    
    ctx.font = "20px 'Baloo 2'";
    ctx.fillStyle = "#666";
    y += 50;
    ctx.fillText("è¯¥æ­»çš„æ°´è¯¾ç»ˆäºç»“æŸäº†ğŸ¤©", width/2, y);
    
    y += 40;
    ctx.font = "bold 24px 'Baloo 2'";
    ctx.fillStyle = "#333";
    ctx.fillText(`æœ€ç»ˆå¾—åˆ†: ${score}`, width/2, y);

    if (score === highScore) {
        y += 30;
        ctx.font = "bold 18px 'Baloo 2'";
        ctx.fillStyle = COLORS.cta;
        ctx.fillText("ğŸ‘‘ æ–°çºªå½•ï¼", width/2, y);
    }

    y += 40;
    ctx.font = "18px 'Baloo 2'";
    ctx.fillStyle = "#FF69B4";
    ctx.fillText(`å¹¸è¿æ•°å­— 6 å’Œ 5 å…±å‡ºç°äº† ${luckyClickCount} æ¬¡`, width/2, y);
    
    y += 30;
    ctx.font = "14px 'Baloo 2'";
    ctx.fillStyle = "#999";
    ctx.fillText("çœ‹æ¥è¿™ä¸¤ä¸ªæ•°å­—å’Œä½ å¾ˆæœ‰ç¼˜~", width/2, y);

    // æ˜¾ç¤ºé‡ç©æŒ‰é’®
    document.getElementById('endGameButtons').style.display = 'flex';
}

/**
 * ==========================================
 * å®ä½“ç®¡ç† (Entities)
 * ==========================================
 */

class Bubble {
    constructor(isDreamMode) {
        this.r = 30 + Math.random() * 15;
        this.x = Math.random() * (width - 2 * this.r) + this.r;
        
        // åŠ¨æ€éš¾åº¦ï¼šé€Ÿåº¦éšå…³å¡æå‡
        let baseSpeed = 80 + (currentStageIndex * 20); // æ¯å…³å¿«20
        
        if (isDreamMode) {
            this.y = -50;
            this.vy = baseSpeed + 20 + Math.random() * 100;
        } else {
            this.y = height + 50;
            this.vy = -(baseSpeed + Math.random() * 80);
        }

        // å¹¸è¿æ•°å­—é€»è¾‘ï¼š25%æ¦‚ç‡æ˜¯6æˆ–5
        let rand = Math.random();
        this.isTrap = false; // é»˜è®¤ä¸ºéé™·é˜±

        // é™·é˜±é€»è¾‘ï¼š10%æ¦‚ç‡æ˜¯é™·é˜± (å¹²æ‰°é¡¹)
        if (Math.random() < 0.1) {
            this.isTrap = true;
            this.emoji = ['ğŸ’£', 'ğŸ’©', 'ğŸ“±', 'ğŸ®'][Math.floor(Math.random()*4)];
            this.color = '#4B5563'; // ç°è‰²
            this.val = -1;
        } else if (rand < 0.25) {
            this.val = Math.random() < 0.5 ? 5 : 6;
            this.isLucky = true;
        } else {
            this.val = Math.floor(Math.random() * 9) + 1;
            this.isLucky = false;
        }
        
        // æ¢¦å¢ƒæ¨¡å¼ä¸‹æ··å…¥ Emoji (éé™·é˜±)
        if (!this.isTrap && isDreamMode && Math.random() < 0.4) {
            this.emoji = ['ğŸ¬', 'ğŸ°', 'ğŸ’¤', 'â­'][Math.floor(Math.random()*4)];
        }
        
        if (!this.isTrap) {
            this.color = `hsl(${Math.random() * 360}, 70%, 90%)`;
        }
        this.dead = false;
    }

    update(dt) {
        this.y += this.vy * dt;
        this.x += Math.sin(this.y * 0.02) * 0.5; // è½»å¾®æ‘†åŠ¨
        
        if (this.vy < 0 && this.y < -50) this.dead = true;
        if (this.vy > 0 && this.y > height + 50) this.dead = true;
    }

    draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
        
        if (this.isTrap) {
            ctx.fillStyle = '#1F2937'; // æ·±ç°
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#EF4444'; // çº¢è¾¹
            ctx.stroke();
        } else if (this.isLucky) {
            ctx.fillStyle = '#fffdf0';
            ctx.fill();
            ctx.lineWidth = 3;
            ctx.strokeStyle = COLORS.luckyBorder;
            ctx.stroke();
            // å¹¸è¿å…‰æ™•
            ctx.shadowColor = COLORS.luckyBorder;
            ctx.shadowBlur = 10;
        } else {
            ctx.fillStyle = this.color;
            ctx.fill();
            ctx.shadowBlur = 0;
        }
        ctx.shadowBlur = 0; // é‡ç½®

        // ç»˜åˆ¶å†…å®¹
        ctx.fillStyle = this.isTrap ? '#fff' : '#333';
        ctx.font = this.isLucky ? "bold 28px sans-serif" : "24px sans-serif";
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        if (this.emoji) {
            ctx.fillText(this.emoji, this.x, this.y);
        } else {
            ctx.fillText(this.val, this.x, this.y);
        }
        
        // å¹¸è¿æ ‡è®°
        if (this.isLucky) {
            ctx.font = "10px sans-serif";
            ctx.fillStyle = "#ffa500";
            ctx.fillText("LUCKY", this.x, this.y + 15);
        }
        // é™·é˜±æ ‡è®°
        if (this.isTrap) {
            ctx.font = "10px sans-serif";
            ctx.fillStyle = "#EF4444";
            ctx.fillText("DON'T", this.x, this.y + 15);
        }
    }
}

class Particle {
    constructor(x, y, color) {
        this.x = x;
        this.y = y;
        this.color = color;
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 150 + 50;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.life = 1.0;
        this.decay = Math.random() * 0.5 + 0.5;
    }
    update(dt) {
        this.x += this.vx * dt;
        this.y += this.vy * dt;
        this.life -= this.decay * dt;
    }
    draw() {
        ctx.globalAlpha = Math.max(0, this.life);
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
    }
}

class FloatingText {
    constructor(x, y, text, color) {
        this.x = x;
        this.y = y;
        this.text = text;
        this.color = color;
        this.life = 1.0;
        this.vy = -50;
    }
    update(dt) {
        this.y += this.vy * dt;
        this.life -= dt;
    }
    draw() {
        ctx.globalAlpha = Math.max(0, this.life);
        ctx.font = "bold 24px sans-serif";
        ctx.fillStyle = this.color;
        ctx.fillText(this.text, this.x, this.y);
        ctx.globalAlpha = 1;
    }
}

function spawnBubble(isDreamMode = false) {
    bubbles.push(new Bubble(isDreamMode));
}

function createExplosion(x, y, color) {
    for (let i = 0; i < 8; i++) {
        particles.push(new Particle(x, y, color));
    }
}

function createFloatingText(x, y, text, color) {
    floatingTexts.push(new FloatingText(x, y, text, color));
}

function updateEntities(dt) {
    // Bubbles
    for (let i = bubbles.length - 1; i >= 0; i--) {
        bubbles[i].update(dt);
        if (bubbles[i].dead) bubbles.splice(i, 1);
    }
    // Particles
    for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update(dt);
        if (particles[i].life <= 0) particles.splice(i, 1);
    }
    // Texts
    for (let i = floatingTexts.length - 1; i >= 0; i--) {
        floatingTexts[i].update(dt);
        if (floatingTexts[i].life <= 0) floatingTexts.splice(i, 1);
    }
}

function drawEntities() {
    bubbles.forEach(b => b.draw());
    particles.forEach(p => p.draw());
    floatingTexts.forEach(t => t.draw());
}

function drawUI(gameMinutes) {
    // ç®€å•çš„å¾—åˆ†æ˜¾ç¤º
    ctx.textAlign = 'right';
    ctx.font = "20px sans-serif";
    ctx.fillStyle = "#333";
    ctx.fillText(`å¾—åˆ†: ${score}`, width - 20, 40);
    
    // è¿›åº¦æ¡
    const progress = Math.min(gameMinutes / TOTAL_MINUTES, 1);
    ctx.fillStyle = "#eee";
    ctx.fillRect(0, height - 5, width, 5);
    ctx.fillStyle = COLORS.lucky;
    ctx.fillRect(0, height - 5, width * progress, 5);
    
    // æ˜¾ç¤ºç›®æ ‡åˆ†æ•°
    const currentTarget = STAGES[currentStageIndex].minScore;
    if (currentTarget > 0 && currentStageIndex < 5) {
        ctx.textAlign = 'left';
        ctx.font = "bold 16px 'Baloo 2'";
        ctx.fillStyle = score >= currentTarget ? COLORS.secondary : COLORS.danger;
        ctx.fillText(`ç›®æ ‡: ${currentTarget}`, 20, 40);
    }
}

function checkLevelPass(stageIndex) {
    const stageConfig = STAGES[stageIndex];
    if (stageConfig.minScore > 0 && score < stageConfig.minScore) {
        gameOver(`åˆ†æ•°ä¸è¶³ï¼(éœ€è¦ ${stageConfig.minScore} åˆ†)`);
    } else {
        // Level Up Animation
        const toast = document.getElementById('levelUpToast');
        toast.style.transform = 'translate(-50%, -50%) scale(1)';
        setTimeout(() => {
            toast.style.transform = 'translate(-50%, -50%) scale(0)';
        }, 2000);
        
        // Bonus points for clearing stage
        score += 100;
        createFloatingText(width/2, height/2 - 50, "Level Cleared! +100", COLORS.secondary);
    }
}

function gameOver(reason) {
    isGameOver = true;
    document.getElementById('gameOverScreen').style.display = 'flex';
    document.getElementById('gameOverReason').textContent = reason;
}

/**
 * ==========================================
 * è¾“å…¥å¤„ç† (Input Handling)
 * ==========================================
 */
function playSound(type) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    const now = audioCtx.currentTime;
    
    if (type === 'hit') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        gain.gain.setValueAtTime(0.1, now); // é™ä½éŸ³é‡
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
    } else if (type === 'lucky') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(600, now);
        osc.frequency.exponentialRampToValueAtTime(1200, now + 0.2);
        gain.gain.setValueAtTime(0.1, now); // é™ä½éŸ³é‡
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now);
        osc.stop(now + 0.3);
    } else if (type === 'start') {
        // æ–°å¢ï¼šæŸ”å’Œçš„å¼€å§‹éŸ³æ•ˆ
        osc.type = 'sine';
        osc.frequency.setValueAtTime(300, now);
        osc.frequency.linearRampToValueAtTime(600, now + 0.5);
        gain.gain.setValueAtTime(0.05, now); // éå¸¸è½»æŸ”
        gain.gain.linearRampToValueAtTime(0.01, now + 0.5);
        osc.start(now);
        osc.stop(now + 0.5);
    } else if (type === 'trap') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, now);
        osc.frequency.linearRampToValueAtTime(50, now + 0.3);
        gain.gain.setValueAtTime(0.5, now);
        gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
        osc.start(now);
        osc.stop(now + 0.3);
    } else if (type === 'miss') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(200, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
    }
}

function handleInput(e) {
    if (isGameOver) return;
    
    // è·å–ç‚¹å‡»åæ ‡
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    // æ£€æŸ¥æ˜¯å¦ç‚¹ä¸­æ³¡æ³¡
    let hit = false;
    for (let i = bubbles.length - 1; i >= 0; i--) {
        const b = bubbles[i];
        const dx = x - b.x;
        const dy = y - b.y;
        if (dx*dx + dy*dy < b.r * b.r * 1.5) { // æ‰©å¤§åˆ¤å®šåŒºåŸŸ
            hit = true;
            processHit(b, i);
            break; // ä¸€æ¬¡åªç‚¹ä¸€ä¸ª
        }
    }
    
    if (!hit) {
        // ç©ºæŒ¥ï¼Œé‡ç½®è¿å‡»
        if (combo > 0) {
            combo = 0;
            createFloatingText(x, y, "Miss! Combo Reset", "#999");
            playSound('miss');
        }
    }
    
    // é˜¶æ®µ3ï¼šæé—®æœŸ - çº¢ç¯åœ (3æ¬¡æœºä¼š)
    if (currentStageIndex === 3 && panicEyeState === 'OPEN') {
        panicStrikeCount++;
        score -= 200; // æ‰£åˆ†æƒ©ç½š
        navigator.vibrate && navigator.vibrate(200);
        triggerShake(); // å±å¹•éœ‡åŠ¨
        
        if (panicStrikeCount >= 3) {
            gameOver("è€å¸ˆå¿ä½ å¾ˆä¹…äº†ï¼(è¢«æŠ“3æ¬¡)");
        } else {
            createFloatingText(x, y, `è¢«å‘ç°äº†ï¼(${panicStrikeCount}/3)`, COLORS.danger);
            // å±å¹•é—ªçº¢è­¦å‘Š
            document.body.style.backgroundColor = COLORS.danger;
            setTimeout(() => document.body.style.backgroundColor = '', 100);
        }
        return;
    }
}

function processHit(b, index) {
    // ç§»é™¤æ³¡æ³¡
    bubbles.splice(index, 1);
    
    // é™·é˜±å¤„ç†
    if (b.isTrap) {
        score -= 50;
        combo = 0;
        createExplosion(b.x, b.y, COLORS.danger);
        createFloatingText(b.x, b.y, "Trap! -50", COLORS.danger);
        playSound('trap');
        triggerShake(); // å±å¹•éœ‡åŠ¨
        navigator.vibrate && navigator.vibrate(100);
        return;
    }

    // è¿å‡»å¤„ç†
    combo++;
    if (combo > maxCombo) maxCombo = combo;
    let comboMultiplier = 1 + (combo * 0.1); // æ¯æ¬¡è¿å‡»å¢åŠ 10%åˆ†æ•°
    
    // åŸºç¡€å¾—åˆ†
    let val = 10;
    let color = '#333';
    let text = `+${Math.floor(val * comboMultiplier)}`;

    // å¹¸è¿æ•°å­—é€»è¾‘
    if (b.isLucky || b.val === 6 || b.val === 5) {
        val = 50;
        color = '#FF69B4'; // ç²‰è‰²
        text = `Lucky! +${Math.floor(val * comboMultiplier)}`;
        luckyClickCount++;
        createExplosion(b.x, b.y, COLORS.luckyBorder);
        playSound('lucky');
    } else {
        createExplosion(b.x, b.y, b.color);
        playSound('hit');
    }
    
    // æ˜¾ç¤ºè¿å‡»æ–‡å­—
    if (combo > 1) {
        text += ` (Combo x${combo})`;
    }

    // é˜¶æ®µ1ï¼šå›°å€¦ - å›è¡€è§†é‡
    if (currentStageIndex === 1) {
        if (b.isLucky || b.val === 6 || b.val === 5) {
            blurLevel = 0; // ç¬é—´æ¸…é†’
            text = "æ¸…é†’äº†ï¼";
        } else {
            blurLevel = Math.max(0, blurLevel - 1);
        }
    }
    
    // é˜¶æ®µ4ï¼šæ•°å­¦ - å‡‘æ•°
    if (currentStageIndex === 4) {
        if (!b.emoji) { // å¿½ç•¥Emoji
            mathCurrent += b.val;
            // ä¿®æ­£ï¼šç®—æœ¯å¾—åˆ†ä¸åº”ç”¨è¿å‡»ï¼Œé¿å…åˆ·åˆ†å¤ªå¿«ï¼Œæˆ–è€…å¯ä»¥åŠ å°‘ä¸€ç‚¹
            text = `+${b.val}`; 
            if (mathCurrent > mathTarget) {
                text = "çˆ†äº†! å½’é›¶";
                color = COLORS.danger;
                mathCurrent = 0;
                combo = 0; // ç®—é”™é‡ç½®è¿å‡»
                playSound('trap');
            }
        }
    }

    score += Math.floor(val * comboMultiplier);
    createFloatingText(b.x, b.y, text, color);
}

</script>
</body>
</html>